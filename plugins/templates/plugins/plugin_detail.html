{% extends 'base.html' %}

{% block title %}{{ object.name }} - Cauldron Plugin Registry{% endblock %}

{% block content %}
<div class="row">
    <div class="col s12">
        <div class="card">
            <div class="card-content">
                <span class="card-title" style="font-weight: 300;">{{ object.name }}</span>
                <p><strong>Version:</strong> {{ object.version }}</p>
                {% if object.commit_hash %}<p><strong>Commit Hash:</strong> {{ object.commit_hash }}</p>{% endif %}
                <p><strong>Author:</strong> {{ object.author.name }}</p>
                <p><strong>Category:</strong> {{ object.category.name }}</p>
                {% if object.subcategory %}<p><strong>Subcategory:</strong> {{ object.subcategory }}</p>{% endif %}
                <p>{{ object.description }}</p>

                {% if object.env_variables.all %}
                <div style="margin-top: 20px;">
                    <h6>Environment Variables</h6>
                    <table class="striped">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Label</th>
                                <th>Type</th>
                                <th>Default</th>
                                <th>Description</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for env in object.env_variables.all %}
                            <tr>
                                <td><code>{{ env.name }}</code></td>
                                <td>{{ env.label }}</td>
                                <td>{{ env.type }}</td>
                                <td>{{ env.default|default:"-" }}</td>
                                <td>{{ env.description }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% endif %}
            </div>
            <div class="card-action">
                {% with registry_url=request.scheme|add:"://"|add:request.get_host %}
                <a href="cauldron://install?repo={{ object.repository|urlencode }}{% if object.commit_hash %}&ref={{ object.commit_hash|urlencode }}{% endif %}&registry={{ registry_url|urlencode }}" class="btn waves-effect waves-light">
                    Install with Cauldron
                    <i class="material-icons right">get_app</i>
                </a>
                {% endwith %}
                {% if user.is_authenticated and object.submitted_by == user %}
                    <div style="margin-top: 15px;">
                        <strong>Owner Actions:</strong>
                        <div id="owner-actions">
                            {% if object.recommended_commit %}
                                <p><strong>Recommended Commit:</strong> <code id="rec-commit">{{ object.recommended_commit|slice:":7" }}</code></p>
                            {% endif %}
                            <div style="margin-top: 10px;">
                                <a href="#" onclick="checkForUpdates(); return false;" class="btn-small waves-effect waves-light blue">
                                    <i class="material-icons left">update</i>Check Updates
                                </a>
                                <a href="#" onclick="refreshPlugin(); return false;" class="btn-small waves-effect waves-light green">
                                    <i class="material-icons left">refresh</i>Refresh Metadata
                                </a>
                                <a href="#" onclick="syncToLatest(); return false;" class="btn-small waves-effect waves-light teal">
                                    <i class="material-icons left">sync</i>Sync to Latest
                                </a>
                            </div>
                            <div style="margin-top: 10px;">
                                <input type="text" id="new-recommended-commit" placeholder="New recommended commit hash" style="max-width: 300px; display: inline-block; margin-right: 10px;">
                                <a href="#" onclick="setRecommendedCommit(); return false;" class="btn-small waves-effect waves-light orange">
                                    <i class="material-icons left">bookmark</i>Set Recommended
                                </a>
                            </div>
                            <div id="action-status" style="margin-top: 10px;"></div>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col s12">
        <div class="card">
            <div class="card-content">
                <span class="card-title" style="font-weight: 300;">README</span>
                <div class="divider"></div>
                <div style="margin-top: 20px;">
                    {{ object.readme|safe }}
                </div>
            </div>
        </div>
    </div>
</div>

{% if user.is_authenticated and object.submitted_by == user %}
<script>
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function setRecommendedCommit() {
        const commitHash = document.getElementById('new-recommended-commit').value;
        if (!commitHash) {
            M.toast({html: 'Please enter a commit hash', classes: 'red'});
            return;
        }

        const statusDiv = document.getElementById('action-status');
        statusDiv.innerHTML = '<div class="progress"><div class="indeterminate"></div></div>';

        fetch('/api/plugins/{{ object.pk }}/set_recommended_commit/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ commit_hash: commitHash })
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                statusDiv.innerHTML = `<div class="chip red lighten-4">Error: ${data.error}</div>`;
            } else {
                statusDiv.innerHTML = `<div class="chip green lighten-4">Recommended commit set successfully!</div>`;
                const recCommitEl = document.getElementById('rec-commit');
                if (recCommitEl) {
                    recCommitEl.textContent = data.recommended_commit.substring(0, 7);
                } else {
                    location.reload();
                }
                document.getElementById('new-recommended-commit').value = '';
                M.toast({html: 'Recommended commit updated!', classes: 'green'});
            }
        })
        .catch(error => {
            statusDiv.innerHTML = `<div class="chip red lighten-4">Error: ${error.message}</div>`;
        });
    }

    function checkForUpdates() {
        const statusDiv = document.getElementById('action-status');
        statusDiv.innerHTML = '<div class="progress"><div class="indeterminate"></div></div>';

        fetch('/api/plugins/{{ object.pk }}/check_my_update/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                statusDiv.innerHTML = `<div class="chip red lighten-4">Error: ${data.error}</div>`;
            } else {
                const current = data.current_commit.substring(0, 7);
                const latest = data.latest_commit.substring(0, 7);
                const updateMsg = data.has_update
                    ? `<strong>Update available!</strong> Current: ${current}, Latest: ${latest}`
                    : `Plugin is up to date (${current})`;
                statusDiv.innerHTML = `<div class="chip ${data.has_update ? 'orange' : 'green'} lighten-4">${updateMsg}</div>`;
                M.toast({html: data.has_update ? 'Update available!' : 'Up to date', classes: data.has_update ? 'orange' : 'green'});
            }
        })
        .catch(error => {
            statusDiv.innerHTML = `<div class="chip red lighten-4">Error: ${error.message}</div>`;
        });
    }

    function refreshPlugin() {
        if (!confirm('This will refresh plugin metadata from the repository. Continue?')) {
            return;
        }

        const statusDiv = document.getElementById('action-status');
        statusDiv.innerHTML = '<div class="progress"><div class="indeterminate"></div></div>';

        fetch('/api/plugins/{{ object.pk }}/refresh/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                statusDiv.innerHTML = `<div class="chip red lighten-4">Error: ${data.error}</div>`;
            } else {
                statusDiv.innerHTML = `<div class="chip green lighten-4">Plugin metadata refreshed successfully!</div>`;
                M.toast({html: 'Plugin refreshed! Reloading page...', classes: 'green'});
                setTimeout(() => location.reload(), 1500);
            }
        })
        .catch(error => {
            statusDiv.innerHTML = `<div class="chip red lighten-4">Error: ${error.message}</div>`;
        });
    }

    function syncToLatest() {
        if (!confirm('This will sync the plugin to the latest commit. Continue?')) {
            return;
        }

        const statusDiv = document.getElementById('action-status');
        statusDiv.innerHTML = '<div class="progress"><div class="indeterminate"></div></div>';

        fetch('/api/plugins/{{ object.pk }}/sync_to_latest/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                statusDiv.innerHTML = `<div class="chip red lighten-4">Error: ${data.error}</div>`;
            } else {
                statusDiv.innerHTML = `<div class="chip green lighten-4">Plugin synced to latest successfully!</div>`;
                M.toast({html: 'Plugin synced! Reloading page...', classes: 'green'});
                setTimeout(() => location.reload(), 1500);
            }
        })
        .catch(error => {
            statusDiv.innerHTML = `<div class="chip red lighten-4">Error: ${error.message}</div>`;
        });
    }
</script>
{% endif %}
{% endblock %}